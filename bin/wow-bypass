#!/bin/bash
# WoW System - Bypass Activation
# Author: Chude <chude@emeke.org>

set -uo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Bootstrap: Discover WOW_HOME and VERSION first (needed for --version)
# ─────────────────────────────────────────────────────────────────────────────
_discover_wow_home() {
    local candidates=(
        "${WOW_HOME:-}"
        "${HOME}/.claude/wow-system"
        "${HOME}/Projects/wow-system"
        "$(dirname "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")")"
    )
    for candidate in "${candidates[@]}"; do
        if [[ -n "${candidate}" && -f "${candidate}/src/security/bypass-core.sh" ]]; then
            echo "${candidate}"
            return 0
        fi
    done
    return 1
}

WOW_HOME="$(_discover_wow_home)" || {
    echo "Error: Cannot find WoW System" >&2
    exit 1
}

VERSION="$(tr -d '[:space:]' < "${WOW_HOME}/VERSION" 2>/dev/null || echo "unknown")"

# ─────────────────────────────────────────────────────────────────────────────
# Global Options (handle before anything else)
# ─────────────────────────────────────────────────────────────────────────────
# Capture duration argument before option parsing
DURATION_ARG=""
for arg in "$@"; do
    case "${arg}" in
        -h|--help|help|-v|--version|version) ;;
        *) DURATION_ARG="${arg}" ;;
    esac
done

case "${1:-}" in
    -h|--help|help)
        cat << EOF

  WoW
  Bypass Activation (Tier 1)

  ────────────────────────────────────────

  Usage
    wow bypass [duration]

  Description
    Temporarily unlock Development zone (~/Projects/*)
    for operations that would normally be blocked.

    Unlocks:
    • DEVELOPMENT zone (~/Projects/*)
    • GENERAL zone (no restrictions)

    Does NOT unlock:
    • CONFIG zone (~/.config/*, ~/.claude/*)
    • SENSITIVE zone (~/.ssh/*, ~/.aws/*)
    • SYSTEM zone (/etc/*, /bin/*, /usr/*)
    • WOW_SELF zone (WoW handlers, hooks)
    • NUCLEAR operations (rm -rf /, fork bombs)

    For config/sensitive/system files, use:
      wow superadmin unlock

    Requires:
    • Interactive terminal (TTY)
    • Configured passphrase
    • Valid integrity checksums

  Duration
    You can specify a custom duration:
    • wow bypass 2h       (2 hours)
    • wow bypass 30m      (30 minutes)
    • wow bypass 1h30m    (1 hour 30 minutes)
    • wow bypass 120      (120 minutes)

    If not specified, you will be prompted
    to confirm the default (4 hours) or
    enter a custom duration.

  Safety
    • Auto-expires based on duration (default 4h)
    • Auto-locks after proportional inactivity
    • Rate limited: 50 operations per minute
    • Nuclear operations always blocked

  Options
    -h, --help      Show this help
    -v, --version   Show version

  See Also
    wow protect          Re-enable protection
    wow status           Check current state
    wow setup            Configure passphrase
    wow superadmin       Unlock all zones (Tier 2)

EOF
        exit 0
        ;;
    -v|--version|version)
        echo "wow-bypass ${VERSION}"
        exit 0
        ;;
esac

# ─────────────────────────────────────────────────────────────────────────────
# Design System
# ─────────────────────────────────────────────────────────────────────────────
C_RESET=$'\033[0m'
C_BOLD=$'\033[1m'
C_DIM=$'\033[2m'
C_WHITE=$'\033[97m'
C_GRAY=$'\033[90m'
C_GREEN=$'\033[32m'
C_YELLOW=$'\033[33m'
C_RED=$'\033[31m'
C_CYAN=$'\033[36m'

# Progress bar
print_progress() {
    local current=$1
    local total=$2
    local width=${3:-16}
    local filled=$((current * width / total))
    local empty=$((width - filled))

    printf "${C_DIM}[${C_RESET}"
    printf "${C_CYAN}%s${C_RESET}" "$(printf '█%.0s' $(seq 1 $filled 2>/dev/null) || true)"
    printf "${C_DIM}%s${C_RESET}" "$(printf '░%.0s' $(seq 1 $empty 2>/dev/null) || true)"
    printf "${C_DIM}]${C_RESET}"
}

# ─────────────────────────────────────────────────────────────────────────────
# Dependencies
# ─────────────────────────────────────────────────────────────────────────────
source "${WOW_HOME}/src/security/bypass-core.sh" || exit 1
source "${WOW_HOME}/src/security/bypass-always-block.sh" 2>/dev/null || true
source "${WOW_HOME}/src/core/duration-parser.sh" 2>/dev/null || true
source "${WOW_HOME}/src/core/interactive-duration.sh" 2>/dev/null || true

# ─────────────────────────────────────────────────────────────────────────────
# Interface
# ─────────────────────────────────────────────────────────────────────────────

echo ""
echo "  ${C_BOLD}${C_WHITE}WoW${C_RESET}"
echo "  ${C_DIM}Bypass Activation${C_RESET}"
echo ""
echo "  ${C_DIM}────────────────────────────────────────${C_RESET}"
echo ""

# Pre-flight checks with progress
total_checks=5
current_check=0

print_check_status() {
    printf "\r  "
    print_progress $current_check $total_checks
    printf " ${C_DIM}%s${C_RESET}" "$1"
}

print_check_status "Checking TTY..."
if ! bypass_check_tty; then
    echo ""
    echo ""
    echo "  ${C_RED}●${C_RESET} Interactive terminal required"
    echo ""
    echo "  ${C_DIM}This command cannot be run by scripts or AI.${C_RESET}"
    echo "  ${C_DIM}Open a terminal and run directly.${C_RESET}"
    echo ""
    exit 1
fi
current_check=$((current_check + 1))

print_check_status "Checking configuration..."
if ! bypass_is_configured; then
    echo ""
    echo ""
    echo "  ${C_YELLOW}●${C_RESET} Not configured"
    echo ""
    echo "  ${C_DIM}Run${C_RESET} ${C_CYAN}wow-bypass-setup${C_RESET} ${C_DIM}first.${C_RESET}"
    echo ""
    exit 1
fi
current_check=$((current_check + 1))

print_check_status "Checking status..."
if bypass_is_active; then
    echo ""
    echo ""
    echo "  ${C_GREEN}●${C_RESET} Already active"
    echo ""
    echo "  ${C_DIM}Bypass mode is currently enabled.${C_RESET}"
    echo "  ${C_DIM}Run${C_RESET} ${C_CYAN}wow protect${C_RESET} ${C_DIM}to re-enable protection.${C_RESET}"
    echo ""
    exit 0
fi
current_check=$((current_check + 1))

print_check_status "Checking rate limit..."
if ! bypass_check_rate_limit 2>/dev/null; then
    echo ""
    exit 1
fi
current_check=$((current_check + 1))

print_check_status "Verifying integrity..."
if ! bypass_verify_checksums 2>/dev/null; then
    echo ""
    echo ""
    echo "  ${C_RED}●${C_RESET} Integrity check failed"
    echo ""
    echo "  ${C_DIM}Scripts may have been modified.${C_RESET}"
    echo ""
    exit 1
fi
current_check=$((current_check + 1))

printf "\r  "
print_progress $total_checks $total_checks
printf " ${C_DIM}All checks passed${C_RESET} ${C_GREEN}✓${C_RESET}\n"
echo ""

# ─────────────────────────────────────────────────────────────────────────────
# Duration Selection
# ─────────────────────────────────────────────────────────────────────────────

# Resolve duration from argument or prompt user
if [[ -n "${DURATION_ARG}" ]]; then
    # User provided duration argument
    SELECTED_DURATION=$(duration_resolve_arg "${DURATION_ARG}" "bypass")
    if [[ -z "${SELECTED_DURATION}" || "${SELECTED_DURATION}" == "0" ]]; then
        echo "  ${C_RED}●${C_RESET} Invalid duration: ${DURATION_ARG}"
        echo ""
        echo "  ${C_DIM}Examples: 2h, 30m, 1h30m, 120${C_RESET}"
        echo ""
        exit 1
    fi
    FORMATTED_DURATION=$(duration_format "${SELECTED_DURATION}")
    INACTIVITY_DURATION=$(duration_calculate_inactivity "${SELECTED_DURATION}" "bypass")
    FORMATTED_INACTIVITY=$(duration_format "${INACTIVITY_DURATION}")

    echo "  ${C_DIM}Duration:${C_RESET} ${C_WHITE}${FORMATTED_DURATION}${C_RESET}"
    echo "  ${C_DIM}Auto-lock after:${C_RESET} ${C_WHITE}${FORMATTED_INACTIVITY}${C_RESET} ${C_DIM}inactivity${C_RESET}"
    echo ""
else
    # No argument - prompt for duration or confirm default
    DEFAULT_DURATION=$(duration_get_default "bypass")
    FORMATTED_DEFAULT=$(duration_format "${DEFAULT_DURATION}")

    echo "  ${C_DIM}Duration${C_RESET}"
    echo ""
    echo "  ${C_DIM}Default:${C_RESET} ${C_WHITE}${FORMATTED_DEFAULT}${C_RESET}"
    echo "  ${C_DIM}Press Enter to accept, or enter custom (e.g., 2h, 30m):${C_RESET}"
    echo ""
    printf "  ${C_WHITE}>${C_RESET} "

    # Read from TTY
    if [[ -t 0 ]]; then
        read -r USER_DURATION < /dev/tty 2>/dev/null || USER_DURATION=""
    else
        USER_DURATION=""
    fi

    if [[ -z "${USER_DURATION}" ]]; then
        # Use default
        SELECTED_DURATION="${DEFAULT_DURATION}"
    else
        # Parse user input
        SELECTED_DURATION=$(duration_parse "${USER_DURATION}")
        if [[ -z "${SELECTED_DURATION}" || "${SELECTED_DURATION}" == "0" ]]; then
            echo ""
            echo "  ${C_YELLOW}●${C_RESET} Invalid format, using default (${FORMATTED_DEFAULT})"
            SELECTED_DURATION="${DEFAULT_DURATION}"
        fi
    fi

    FORMATTED_DURATION=$(duration_format "${SELECTED_DURATION}")
    INACTIVITY_DURATION=$(duration_calculate_inactivity "${SELECTED_DURATION}" "bypass")
    FORMATTED_INACTIVITY=$(duration_format "${INACTIVITY_DURATION}")

    echo ""
    echo "  ${C_GREEN}●${C_RESET} ${C_WHITE}${FORMATTED_DURATION}${C_RESET} ${C_DIM}(auto-lock after ${FORMATTED_INACTIVITY} inactivity)${C_RESET}"
    echo ""
fi

# Authentication
passphrase=$(bypass_read_passphrase "  ${C_WHITE}Passphrase${C_RESET} ") || {
    echo ""
    echo "  ${C_RED}●${C_RESET} Failed to read input"
    exit 1
}

verify_result=0
bypass_verify_passphrase "${passphrase}" || verify_result=$?
passphrase=""

if [[ ${verify_result} -ne 0 ]]; then
    bypass_record_failure 2>/dev/null
    echo ""
    echo "  ${C_RED}●${C_RESET} Incorrect passphrase"
    echo ""
    exit 1
fi

# Activate
echo ""
printf "  ${C_DIM}Activating...${C_RESET}"

if ! bypass_activate "${SELECTED_DURATION}" "${INACTIVITY_DURATION}" 2>/dev/null; then
    echo ""
    echo "  ${C_RED}●${C_RESET} Activation failed"
    exit 1
fi

echo " ${C_GREEN}✓${C_RESET}"

# Success
echo ""
echo "  ${C_DIM}────────────────────────────────────────${C_RESET}"
echo ""
echo "  ${C_GREEN}●${C_RESET} ${C_BOLD}Bypass Active (Tier 1)${C_RESET}"
echo ""
echo "  ${C_DIM}Duration:${C_RESET} ${C_WHITE}${FORMATTED_DURATION}${C_RESET}"
echo "  ${C_DIM}Auto-lock:${C_RESET} ${C_WHITE}${FORMATTED_INACTIVITY}${C_RESET} ${C_DIM}inactivity${C_RESET}"
echo ""
echo "  ${C_DIM}Unlocked: DEVELOPMENT zone (~/Projects/*)${C_RESET}"
echo ""
echo "  ${C_DIM}Config, sensitive, and system files still protected.${C_RESET}"
echo "  ${C_DIM}Run${C_RESET} ${C_CYAN}wow superadmin unlock${C_RESET} ${C_DIM}for those.${C_RESET}"
echo "  ${C_DIM}Run${C_RESET} ${C_CYAN}wow protect${C_RESET} ${C_DIM}when done.${C_RESET}"
echo ""
