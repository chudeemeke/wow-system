# GitHub Actions Workflow: docTruth Documentation Validation
# Author: Chude <chude@emeke.org>
#
# Purpose: Ensures documentation is always current before merging PRs
# Strategy: Hybrid enforcement (validate on PRs, allow fixes)

name: Documentation Validation

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master]
  workflow_dispatch:  # Manual trigger

jobs:
  validate-docs:
    name: Validate Documentation with docTruth
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate truth capture

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install docTruth
        run: |
          npm install -g doctruth
          doctruth --version

      - name: Check for docTruth configuration
        id: check-config
        run: |
          if [ -f .doctruth.yml ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
            echo "‚úì Found .doctruth.yml configuration"
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No .doctruth.yml found - skipping validation"
          fi

      - name: Validate documentation is current
        if: steps.check-config.outputs.config_exists == 'true'
        run: |
          echo "üîç Checking if documentation is up to date..."
          doctruth --check
        continue-on-error: true
        id: check-docs

      - name: Generate documentation update
        if: steps.check-docs.outcome == 'failure'
        run: |
          echo "üìö Documentation is outdated, generating update..."
          doctruth

          # Check if there are changes
          if git diff --exit-code CURRENT_TRUTH.md; then
            echo "‚úì Documentation was already current"
          else
            echo "‚ùå Documentation was outdated and has been updated"
            echo "Please commit the updated CURRENT_TRUTH.md"
            exit 1
          fi

      - name: Upload truth file artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: current-truth
          path: CURRENT_TRUTH.md
          retention-days: 30

      - name: Comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìö Documentation Update Required

              Your documentation is outdated. Please run:

              \`\`\`bash
              doctruth
              git add CURRENT_TRUTH.md
              git commit -m "docs: update CURRENT_TRUTH.md"
              \`\`\`

              Or download the updated file from the workflow artifacts.`
            })

  validate-config:
    name: Validate docTruth Configuration
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install docTruth
        run: npm install -g doctruth

      - name: Validate YAML syntax
        if: hashFiles('.doctruth.yml') != ''
        run: |
          echo "Validating .doctruth.yml syntax..."
          node -e "
            const yaml = require('js-yaml');
            const fs = require('fs');
            try {
              const config = yaml.load(fs.readFileSync('.doctruth.yml', 'utf8'));
              console.log('‚úì Valid YAML syntax');
              console.log('Project:', config.project);
              console.log('Truth sources:', config.truth_sources?.length || 0);
              console.log('Validations:', config.validations?.length || 0);
            } catch (e) {
              console.error('‚úó Invalid YAML:', e.message);
              process.exit(1);
            }
          "

  # Optional: Auto-update documentation on main branch
  auto-update-docs:
    name: Auto-Update Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install docTruth
        run: npm install -g doctruth

      - name: Update documentation
        if: hashFiles('.doctruth.yml') != ''
        run: |
          echo "Generating fresh documentation..."
          doctruth

      - name: Commit updated docs
        run: |
          git config --local user.email "noreply@github.com"
          git config --local user.name "GitHub Actions"

          if git diff --exit-code CURRENT_TRUTH.md; then
            echo "No documentation changes"
          else
            git add CURRENT_TRUTH.md
            git commit -m "docs: auto-update CURRENT_TRUTH.md [skip ci]"
            git push
            echo "‚úì Documentation updated automatically"
          fi
